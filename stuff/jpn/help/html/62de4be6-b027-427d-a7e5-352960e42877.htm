<html xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:MSHelp="http://msdn.microsoft.com/mshelp" xmlns:mshelp="http://msdn.microsoft.com/mshelp" xmlns:ddue="http://ddue.schemas.microsoft.com/authoring/2003/5" xmlns:msxsl="urn:schemas-microsoft-com:xslt"><head><META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8" /><META NAME="save" CONTENT="history" /><title>高可用性、障害回復のための JDBC Driver のサポート</title><meta name="Language" content="ja-jp" /><meta name="Microsoft.Help.Id" content="62de4be6-b027-427d-a7e5-352960e42877" /><meta name="Description" content="このトピックでは、高可用性と障害回復を実現する AlwaysOn 可用性グループのための Microsoft JDBC Driver for SQL Server のサポートについて説明します。AlwaysOn 可用性グループの詳細については、SQL Server 2012 オンライン ブックを参照してください。" /><meta name="Microsoft.Help.ContentType" content="Concepts" /><link rel="stylesheet" type="text/css" href="../local/Classic.css" /><script type="text/javascript" src="../scripts/EventUtilities.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/SplitScreen.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/Dropdown.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/script_manifold.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/script_feedBack.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/CheckboxMenu.js">&amp;nbsp;</script><script type="text/javascript" src="../scripts/CommonUtilities.js">&amp;nbsp;</script><script type="text/javascript" src="../local/script_main.js">&amp;nbsp;</script></head><body><div id="header"><table id="bottomTable" cellpadding="0" cellspacing="0"><tr><td align="left"><span id="headerBold">高可用性、障害回復のための JDBC Driver のサポート</span></td></tr></table><table id="gradientTable"><tr><td class="nsrBottom" background="../icons/gradient.gif" /></tr></table></div><div id="mainSection"><div id="mainBody"><div class="introduction"><p>このトピックでは、高可用性と障害回復を実現する AlwaysOn 可用性グループのための Microsoft JDBC Driver for SQL Server のサポートについて説明します。AlwaysOn 可用性グループの詳細については、SQL Server 2012 オンライン ブックを参照してください。</p><p>Version 4.0 以降の Microsoft JDBC Driver for SQL Server では、接続プロパティを使用して、(高可用性、障害回復) 可用性グループ (AG) の可用性グループ リスナーを指定できます。Microsoft JDBC Driver for SQL Server アプリケーションを AlwaysOn データベースに接続しているときにフェールオーバーが発生した場合、元の接続は切断され、アプリケーションはフェールオーバー後に処理を続行するために新しい接続を開く必要があります。</p><p>可用性グループ リスナーに接続していないときに複数の IP アドレスがサーバーに関連付けられた場合、Microsoft JDBC Driver for SQL Server は、1 つ目の IP アドレスへの接続を試行します。Microsoft JDBC Driver for SQL Server が 1 つ目の IP アドレスとの間に接続を確立できない場合、接続は失敗します。Microsoft JDBC Driver for SQL Server は、サーバーに関連付けられているその他の IP アドレスへの接続は試行しません。可用性グループ リスナーに接続している場合、Microsoft JDBC Driver for SQL Server は、同時にすべての IP アドレスとの間で接続の確立を試行します。接続試行が成功した場合、ドライバーは未解決の試行をすべて破棄します。</p><div style="margin: .5em 1.5em .5em 1.5em"><b></b><p>接続タイムアウト値を大きくし、接続の再試行ロジックを実装することにより、アプリケーションが可用性グループに接続する可能性は大きくなります。また、可用性グループのフェールオーバーによって接続が失敗することがあるため、失敗した接続が再接続されるように接続の再試行ロジックを実装する必要があります。</p></div><p>Microsoft JDBC Driver 4.0 for SQL Server では、次の<a href="f1b62700-f046-488d-bd6b-a5cd8fc345b7.htm">接続プロパティ</a>が追加されました。</p><ul><li><p><span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span></p></li><li><p><span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span></p></li></ul></div><h1 class="heading">MultiSubnetFailover を使用した接続</h1><div id="sectionSection0" class="section" name="collapseableSection" style=""><p>SQL Server 2012 可用性グループまたは SQL Server 2012 フェールオーバー クラスター インスタンスの可用性グループ リスナーに接続する場合は必ず <span sdata="langKeyword" value="multiSubnetFailover=true"><span class="keyword">multiSubnetFailover=true</span></span> を指定してください。<span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> は、SQL Server 2012 のすべての可用性グループおよびフェールオーバー クラスター インスタンスのより高速なフェールオーバーを可能にし、単一サブネットおよびマルチサブネットの AlwaysOn トポロジのフェールオーバー時間を大幅に短縮します。マルチサブネット フェールオーバー中、クライアントは同時接続を試行します。サブネット フェールオーバー中、Microsoft JDBC Driver for SQL Server は TCP 接続を積極的に再試行します。</p><p><span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> 接続プロパティは、アプリケーションが可用性グループまたはフェールオーバー クラスター インスタンスへの展開の対象であり、Microsoft JDBC Driver for SQL Server がすべての IP アドレスへの接続を試行することによってプライマリ SQL Server インスタンス上のデータベースへの接続を試行することを意味します。接続に対して <span sdata="langKeyword" value="MultiSubnetFailover=true"><span class="keyword">MultiSubnetFailover=true</span></span> を指定した場合、クライアントは、オペレーティング システムの既定の TCP 再送信間隔より短い間隔で TCP 接続を再試行します。これにより、AlwaysOn 可用性グループまたは AlwaysOn フェールオーバー クラスター インスタンスのフェールオーバー後の再接続が高速化され、単一およびマルチサブネット可用性グループとフェールオーバー クラスター インスタンスの両方に適用できるようになります。</p><p>Microsoft JDBC Driver for SQL Server の接続文字列キーワードの詳細については、「<span sdata="link"><a href="f1b62700-f046-488d-bd6b-a5cd8fc345b7.htm">接続プロパティの設定</a></span>」を参照してください。</p><p>可用性グループ リスナーまたはフェールオーバー クラスター インスタンス以外に接続するときに <span sdata="langKeyword" value="multiSubnetFailover=true"><span class="keyword">multiSubnetFailover=true</span></span> を指定するとパフォーマンスが低下する可能性があるため、このような指定はサポートされていません。</p><p>セキュリティ マネージャーがインストールされていない場合、Java 仮想マシンにより仮想 IP アドレス (VIP) が期限付きでキャッシュされます。この期限は、既定で JDK 実装および Java プロパティ (networkaddress.cache.ttl および networkaddress.cache.negative.ttl) によって定義されます。JDK セキュリティ マネージャーがインストールされている場合、Java 仮想マシンにより VIP がキャッシュされます。このキャッシュは、既定で更新されません。Java 仮想マシン キャッシュの "有効期限" (networkaddress.cache.ttl) を 1 日に設定する必要があります。既定値を 1 日 (またはその他の値) に変更しない場合、VIP が追加または更新されたときに古い値が削除されません。networkaddress.cache.ttl と networkaddress.cache.negative.ttl の詳細については、<a href="http://download.oracle.com/javase/6/docs/technotes/guides/net/properties.html">http://download.oracle.com/javase/6/docs/technotes/guides/net/properties.html</a> を参照してください。</p><p>可用性グループのサーバーまたはフェールオーバー クラスター インスタンスに接続する場合は、次のガイドラインに従ってください。</p><ul><li><p><span sdata="langKeyword" value="instanceName"><span class="keyword">instanceName</span></span> 接続プロパティを <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> 接続プロパティと同じ接続文字列内で使用した場合、ドライバーはエラーを生成します。これは、SQL ブラウザーは可用性グループ内で使用されないという事実を反映しています。ただし、<span sdata="langKeyword" value="portNumber"><span class="keyword">portNumber</span></span> 接続プロパティも指定した場合、ドライバーは <span sdata="langKeyword" value="instanceName"><span class="keyword">instanceName</span></span> を無視し、<span sdata="langKeyword" value="portNumber"><span class="keyword">portNumber</span></span> を使用します。</p></li><li><p>単一サブネットまたはマルチサブネットに接続する場合に <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> 接続プロパティを使用すると、パフォーマンスを向上させることができます。</p></li><li><p>可用性グループに接続するには、接続文字列内で可用性グループの可用性グループ リスナーをサーバーとして指定します。たとえば、jdbc:sqlserver://VNN1 のように指定します。</p></li><li><p>64 を超える IP アドレスが構成されている SQL Server インスタンスに接続すると、接続エラーが発生します。</p></li><li><p><span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> 接続プロパティを使用するアプリケーションの動作は、認証の種類 (SQL Server 認証、Kerberos 認証、Windows 認証) に影響されません。</p></li><li><p>フェールオーバー時間に合わせて、アプリケーションの接続再試行回数を減らすには、<span sdata="langKeyword" value="loginTimeout"><span class="keyword">loginTimeout</span></span> の値を大きくします。</p></li><li><p>分散トランザクションはサポートされません。</p></li></ul><p>読み取り専用ルーティングが有効でない場合、次の状況で可用性グループのセカンダリ レプリカの場所への接続が失敗します。</p><ol><li><p>セカンダリ レプリカの場所が接続を受け入れるように構成されていない場合</p></li><li><p>アプリケーションで (以降で説明する) <span sdata="langKeyword" value="applicationIntent=ReadWrite"><span class="keyword">applicationIntent=ReadWrite</span></span> が使用され、セカンダリ レプリカの場所が読み取り専用アクセス用に構成されている場合。</p></li></ol><p>プライマリ レプリカが読み取り専用ワークロードを拒否するように構成されていて、接続文字列に <span sdata="langKeyword" value="ApplicationIntent=ReadOnly"><span class="keyword">ApplicationIntent=ReadOnly</span></span> が含まれる場合、接続は失敗します。</p></div><h1 class="heading">マルチサブネット クラスターを使用するためのデータベース ミラーリングからのアップグレード</h1><div id="sectionSection1" class="section" name="collapseableSection" style=""><p>現在データベース ミラーリングを使用している Microsoft JDBC Driver for SQL Server アプリケーションをマルチサブネット シナリオにアップグレードする場合、<span sdata="langKeyword" value="failoverPartner"><span class="keyword">failoverPartner</span></span> 接続プロパティを削除し、<span sdata="langKeyword" value="true"><span class="keyword">true</span></span> に設定した <span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> で置き換える必要があります。このとき、接続文字列のサーバー名を可用性グループ リスナーに置き換えます。接続文字列に <span sdata="langKeyword" value="failoverPartner"><span class="keyword">failoverPartner</span></span> と <span sdata="langKeyword" value="multiSubnetFailover=true"><span class="keyword">multiSubnetFailover=true</span></span> が使用されている場合、ドライバーはエラーを生成します。ただし、接続文字列に <span sdata="langKeyword" value="failoverPartner"><span class="keyword">failoverPartner</span></span> と <span sdata="langKeyword" value="multiSubnetFailover=false"><span class="keyword">multiSubnetFailover=false</span></span> (または <span sdata="langKeyword" value="ApplicationIntent=ReadWrite"><span class="keyword">ApplicationIntent=ReadWrite</span></span>) が使用されている場合、アプリケーションはデータベース ミラーリングを使用します。</p><p>ドライバーは、AG のプライマリ データベースでデータベース ミラーリングが使用されている場合、および可用性グループ リスナーではなくプライマリ データベースに接続する接続文字列内で <span sdata="langKeyword" value="multiSubnetFailover=true"><span class="keyword">multiSubnetFailover=true</span></span> が使用されている場合、エラーを返します。</p></div><h1 class="heading">アプリケーション インテントの指定</h1><div id="sectionSection2" class="section" name="collapseableSection" style=""><p><span sdata="langKeyword" value="applicationIntent=ReadOnly"><span class="keyword">applicationIntent=ReadOnly</span></span> の場合、クライアントは、AlwaysOn 対応データベースに接続するときに読み取り専用ワークロードを要求します。サーバーは、接続時およびデータベース ステートメントの使用時にインテントを強制しますが、その対象は AlwaysOn 対応データベースのみです。</p><p><span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span> キーワードは、従来の読み取り専用データベースに対しては無効です。</p><p>データベースは、対象の AlwaysOn データベースの読み取りワークロードを許可または禁止できます (この操作には、<span sdata="langKeyword" value="PRIMARY_ROLE"><span class="keyword">PRIMARY_ROLE</span></span> および <span sdata="langKeyword" value="SECONDARY_ROLE"><span class="keyword">SECONDARY_ROLE</span></span> Transact-SQL ステートメントの <span sdata="langKeyword" value="ALLOW_CONNECTIONS"><span class="keyword">ALLOW_CONNECTIONS</span></span> 句を使用します)。</p><p>読み取り専用ルーティングを有効にするには、<span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span> キーワードを使用します。</p></div><h1 class="heading">読み取り専用ルーティング</h1><div id="sectionSection3" class="section" name="collapseableSection" style=""><p>読み取り専用ルーティングは、データベースの読み取り専用レプリカの可用性を実現する機能です。読み取り専用ルーティングは、次の場合に有効になります。</p><ol><li><p>AlwaysOn 可用性グループの可用性グループ リスナーに接続している。</p></li><li><p><span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span> 接続文字列キーワードが <span sdata="langKeyword" value="ReadOnly"><span class="keyword">ReadOnly</span></span> に設定されている。</p></li><li><p> データベース管理者によって可用性グループでの読み取り専用ルーティングが有効に構成されている。</p></li></ol><p>読み取り専用ルーティングを使用する複数の接続がすべて同じ読み取り専用レプリカに接続するとは限りません。データベース同期の変更またはサーバーのルーティング構成の変更により、クライアントが異なる読み取り専用レプリカに接続することがあります。すべての読み取り専用要求が同じ読み取り専用レプリカに接続するようにするには、可用性グループ リスナーまたは仮想 IP アドレスを <span sdata="langKeyword" value="serverName"><span class="keyword">serverName</span></span> 接続文字列キーワードに渡さないようにします。代わりに、読み取り専用インスタンスの名前を指定します。</p><p>読み取り専用ルーティングでは、最初にプライマリに接続した後、使用できる最善の読み取り可能セカンダリが検索されます。このため、読み取り専用ルーティングに要する時間は、プライマリに接続するよりも長くなります。したがって、ログイン タイムアウトを長く設定する必要があります。</p></div><h1 class="heading">multiSubnetFailover および applicationIntent をサポートする新しいメソッド</h1><div id="sectionSection4" class="section" name="collapseableSection" style=""><p>次のメソッドは、<span sdata="langKeyword" value="multiSubnetFailover"><span class="keyword">multiSubnetFailover</span></span> および <span sdata="langKeyword" value="applicationIntent"><span class="keyword">applicationIntent</span></span> 接続文字列キーワードへのプログラムによるアクセスが可能です。</p><ul><li><p><a href="19411e6c-c456-4533-8252-54569a2a6b1f.htm">SQLServerDataSource.getApplicationIntent</a></p></li><li><p><a href="e164c8ac-a0ae-4638-affb-ed454e7c0708.htm">SQLServerDataSource.setApplicationIntent</a></p></li><li><p><a href="1e8cb175-5f4c-4208-b4f5-3646990a30e3.htm">SQLServerDataSource.getMultiSubnetFailover</a></p></li><li><p><a href="7ffd282d-c2f6-4d1b-a7a6-859d18b388aa.htm">SQLServerDataSource.setMultiSubnetFailover</a></p></li><li><p><a href="b5eaad8a-31ef-44ac-af11-d5caa13ac3e2.htm">SQLServerDriver.getPropertyInfo</a></p></li></ul><p><span sdata="langKeyword" value="getMultiSubnetFailover"><span class="keyword">getMultiSubnetFailover</span></span>、<span sdata="langKeyword" value="setMultiSubnetFailover"><span class="keyword">setMultiSubnetFailover</span></span>、<span sdata="langKeyword" value="getApplicationIntent"><span class="keyword">getApplicationIntent</span></span>、および <span sdata="langKeyword" value="setApplicationIntent"><span class="keyword">setApplicationIntent</span></span> メソッドは、<span sdata="link"><a href="097434fd-2b74-411c-a5ed-eba04481dde5.htm">SQLServerDataSource クラス</a></span>、<span sdata="link"><a href="b00e5a90-2af7-4d04-8ef8-256183777dcf.htm">SQLServerConnectionPoolDataSource クラス</a></span>、および <span sdata="link"><a href="95fc7b07-2498-4a7e-8f7f-ee0d86b598b4.htm">SQLServerXADataSource クラス</a></span>にも追加されています。</p></div><h1 class="heading">SSL 証明書の検証</h1><div id="sectionSection5" class="section" name="collapseableSection" style=""><p>可用性グループは、複数の物理サーバーから構成されます。Microsoft JDBC Driver 4.0 for SQL Server では、SSL 証明書における <span sdata="langKeyword" value="Subject Alternate Name"><span class="keyword">Subject Alternate Name</span></span> のサポートが追加されているため、複数のホストを同じ証明書に関連付けることができます。SSL の詳細については、「<span sdata="link"><a href="073f3b9e-8edd-4815-88ea-de0655d0325e.htm">SSL のサポートについて</a></span>」を参照してください。</p></div><span id="seeAlsoSpan"><h1 class="heading">関連項目</h1></span><div id="seeAlsoSection" class="section" name="collapseableSection" style=""><div class="seeAlsoStyle"><span sdata="link"><a href="f1b62700-f046-488d-bd6b-a5cd8fc345b7.htm">接続プロパティの設定</a></span></div><div class="seeAlsoStyle"><span sdata="link"><a href="94bcfbe3-f00e-4774-bda8-bb7577518fec.htm">JDBC ドライバーによる SQL Server への接続</a></span></div></div></div><div id="footer" class="section"><span id="feedbackarea">このトピックに関する<a href="javascript:SubmitFeedback('DevDocs@Microsoft.com','','','','8.0.12060.10000','%0\dフィードバックありがとうございます。開発チームは、皆様からのフィードバックに基づいてドキュメントを改善しています。フィードバックを確認中、内容の確認または解決策に関するご意見をうかがうために電子メールをお送りする場合があります。お客様の電子メール アドレスをそれ以外の目的で使用することはありません。また、確認完了後はお客様の電子メール アドレス情報を削除させていただきます。%0\Aマイクロソフトのプライバシーに関する声明の詳細については、http://privacy.microsoft.com/ja-jp/default.aspx を参照してください。%0\A%0\d','カスタマー フィードバック');">フィードバック</a>を Microsoft にお送りください。</span><span id="copyrightarea"><p><a href="9bad553b-9e70-4696-8499-2e35f772a1e0.htm">© 2012 Microsoft.All rights reserved.</a></p></span></div></div></body></html>